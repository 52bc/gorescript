<!doctype html>

<html>
<head>

	<title>Graph Visualization</title>

	<style>
	
		body { margin: 0; padding: 0; overflow: hidden; background-color: #000; }
		canvas { position: fixed; }
	
	</style>

</head>
<body>	

	<script src="../deps/jquery.min.js"></script>
	<script src="../deps/jszip.min.js"></script>
	<script src="../deps/three.min.js"></script>

	<script src="../common/Base.js"></script>
	<script src="../common/Extensions.js"></script>
	<script src="../common/InputHelper.js"></script>
	<script src="../common/MathHelper.js"></script>
	<script src="../common/PolygonHelper.js"></script>
	<script src="../common/LineHelper.js"></script>
	<script src="../common/Canvas2d.js"></script>
	<script src="../common/MapEnums.js"></script>

	<script src="../game/js/ui/DebugUI.js"></script>
	<script src="../game/js/loaders/MapLoader.js"></script>

	<script>

		var cvs;
		var map;
		var sectorGraph;
		var sectorDict;

		function init() {
			cvs = new GS.Canvas2d();
			cvs.init();
			cvs.bufferCtx.translate(0, 300);

			constructSectorGraph(map.sectorLinks);
			GS.DebugUI.setStaticLine("sectors", Object.keys(sectorDict).length);
		}

		function update() {
		}

		function draw() {
			cvs.clear();

			drawMap();

			cvs.flip();
		}

		function drawMap() {
			var sectors = map.layerObjects[GS.MapLayers.Sector];
			var color = new THREE.Color();
			for (var i = 0; i < sectors.length; i++) {
				var sector = sectors[i];
				if (!sector.door) {
					var height = (sector.floorTopY / 16) * 0.5 + 0.25;
					color.setRGB(height, height, height);
				} else {
					color.setRGB(1, 1, 0);
				}
				cvs.polygonFill(sector.vertices, color.getStyle());
			}

			// var segs = map.layerObjects[GS.MapLayers.Segment];
			// for (var i = 0; i < segs.length; i++) {
			// 	cvs.line(segs[i].start.clone().add(drawOffset), segs[i].end.clone().add(drawOffset), "#800000");
			// }

			for (var i in sectorDict) {
				var info = sectorDict[i];
				if (!info.sector.door) {
					cvs.circleFill(info.center, 5, "blue");
				} else {
					cvs.circleFill(info.center, 5, "red");
				}

				var neighbors = sectorGraph.neighborSets[info.index].elements;
				for (var j = 0; j < neighbors.length; j++) {
					var info2 = sectorDict[neighbors[j].id];
					cvs.line(info.center, info2.center, "blue", 1);
				}
			}
		}

		function constructSectorGraph(sectorLinks) {
			sectorGraph = new GS.Graph(function(a, b) { return a.id == b.id });
			sectorDict = {};

			for (var i = 0; i < sectorLinks.length; i += 2) {
				var s1 = getSectorById(sectorLinks[i]);
				var s2 = getSectorById(sectorLinks[i + 1]);

				sectorDict[s1.id] = { index: -1, sector: s1, center: getSectorCenter(s1) };
				sectorDict[s2.id] = { index: -1, sector: s2, center: getSectorCenter(s2) };

				sectorGraph.addEdge(s1, s2);
			}

			var keys = Object.keys(this.sectorDict);
			for (var i = 0; i < keys.length; i++) {
				var obj = sectorDict[keys[i]];
				obj.index = sectorGraph.getVertexIndex(obj.sector);
			}
			
			sectorGraph.computeVertexNeighborSets();
		}

		function getSectorById(id) {
			var sectors = map.layerObjects[GS.MapLayers.Sector];
			for (var i = 0; i < sectors.length; i++) {
				if (sectors[i].id == id) {
					return sectors[i];
				}
			}

			throw "sector " + id + " not found";
		}

		function getSectorCenter(sector) {
			var center = new THREE.Vector2();
			for (var i = 0; i < sector.vertices.length; i++) {
				center.add(sector.vertices[i]);				
			}
			center.divideScalar(sector.vertices.length);
			return center;
		}

		// --------------------------

		var Game = function() {
			GS.Base.call(this);

			this.showFPS = false;
		};

		Game.prototype = GS.inherit(GS.Base, {
			init: function() {
				GS.DebugUI.init();
				GS.DebugUI.visible = true;

				GS.Base.prototype.init.apply(this);
			},

			load: function() {
				var that = this;
				$("#game-canvas").remove();

				var mapLoader = new GS.MapLoader();
				mapLoader.mapPath = "../game/assets/maps/";
				mapLoader.load("airstrip1", "airstrip1.js", function(data) {
					map = mapLoader.parse(data);
					init();
					GS.Base.prototype.load.apply(that);
				});
			},

			update: function() {
				GS.DebugUI.update();
				update();
			},

			draw: function() {
				draw();				
			},
		});

		var GAME;
		window.addEventListener("load", function() {
			GAME = new Game();
			GAME.init();
		}, false);
	
	</script>

</body>
</html>